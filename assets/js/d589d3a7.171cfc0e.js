"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[162],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var s=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,s,i=function(e,t){if(null==e)return{};var n,s,i={},r=Object.keys(e);for(s=0;s<r.length;s++)n=r[s],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(s=0;s<r.length;s++)n=r[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=s.createContext({}),p=function(e){var t=s.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},d=function(e){var t=p(e.components);return s.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},u=s.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),u=p(n),m=i,g=u["".concat(l,".").concat(m)]||u[m]||c[m]||r;return n?s.createElement(g,a(a({ref:t},d),{},{components:n})):s.createElement(g,a({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,a=new Array(r);a[0]=u;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:i,a[1]=o;for(var p=2;p<r;p++)a[p]=n[p];return s.createElement.apply(null,a)}return s.createElement.apply(null,n)}u.displayName="MDXCreateElement"},9390:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>c,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var s=n(7462),i=(n(7294),n(3905));const r={slug:"/"},a=void 0,o={unversionedId:"getting-started",id:"getting-started",title:"getting-started",description:"Getting Started",source:"@site/docs/getting-started.md",sourceDirName:".",slug:"/",permalink:"/workshop-starter/",draft:!1,tags:[],version:"current",frontMatter:{slug:"/"},sidebar:"tutorialSidebar",previous:{title:"Getting Started",permalink:"/workshop-starter/"}},l={},p=[{value:"Getting Started",id:"getting-started",level:2},{value:"Create Nest Application",id:"create-nest-application",level:2},{value:"Fetching Heroes",id:"fetching-heroes",level:3},{value:"Add Get Method",id:"add-get-method",level:2},{value:"Configure Cypress",id:"configure-cypress",level:3},{value:"Add service",id:"add-service",level:2},{value:"Get single mission",id:"get-single-mission",level:2},{value:"add delete method",id:"add-delete-method",level:3},{value:"add db reset for testing",id:"add-db-reset-for-testing",level:2},{value:"add mission method",id:"add-mission-method",level:2},{value:"update mission",id:"update-mission",level:2},{value:"Validation",id:"validation",level:2},{value:"Exclude properties",id:"exclude-properties",level:2},{value:"Protect reset db route with guard",id:"protect-reset-db-route-with-guard",level:2}],d={toc:p};function c(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,s.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"getting-started"},"Getting Started"),(0,i.kt)("p",null,"Greetings, friend! In this tutorial, we are going to cover creating an API using the ",(0,i.kt)("a",{parentName:"p",href:"https://nestjs.com"},"NestJS")," framework. Along the way, we will build out the application using tests with ",(0,i.kt)("a",{parentName:"p",href:"https://cypress.io"},"Cypress")," and the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/filiphric/cypress-plugin-api"},"Cypress API Plugin"),"."),(0,i.kt)("p",null,"If you are not familiar with NestJS, it is a Node based framework heavily influenced by Angular and is great for building any type of server side application with. What I like about Nest is that it provides building blocks (similar to those found in Angular) for creating applications. This helps those who are already familiar with Nest and how it works to jump from project to project and know roughly how things already work."),(0,i.kt)("p",null,"Cypress is typically known for end-to-end testing web applications, as well as component testing. With the Cypress API Plugin, we can use Cypress to test our backend applications as well. The plugin provides a nice interface that shows the results from each API call. Typically I would reach for something like Postman to use when I develop APIs, but with Cypress, I can nearly replace Postman and have a nice suite of automated tests to go along with it when I'm done."),(0,i.kt)("p",null,"For this tutorial, we are creating an mission board for a fictional agency known as Cypress Heroes. This board will feature a list of missions that our heroes can partake in. We'll be able to get, create, update, and delete missions in the board. Yes, its pretty much a todo list, but its much cooler because, you know, super heroes."),(0,i.kt)("p",null,"To get started, you will need to have a relatively newer of Node installed and a code editor (like VS Code)."),(0,i.kt)("h2",{id:"create-nest-application"},"Create Nest Application"),(0,i.kt)("p",null,"The first thing we will do is install the Nest CLI tool:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"npm i -g @nestjs/cli\n")),(0,i.kt)("p",null,"Next, use the CLI to create a new application:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"nest new cypress-heroes-api\n")),(0,i.kt)("p",null,"When prompted, select NPM as your package manager."),(0,i.kt)("p",null,"Go into the newly created ",(0,i.kt)("strong",{parentName:"p"},"cypress-heroes-api")," directory and install Cypress and the plugin:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"npm i -D cypress cypress-plugin-api\n")),(0,i.kt)("p",null,"Next, open the project in your code editor (we'll be using VS Code in the tutorial):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"code .\n")),(0,i.kt)("h3",{id:"fetching-heroes"},"Fetching Heroes"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"nest g controller missions\n")),(0,i.kt)("p",null,"Go over new controller code and how it was added to module."),(0,i.kt)("p",null,"Delete spec"),(0,i.kt)("h2",{id:"add-get-method"},"Add Get Method"),(0,i.kt)("p",null,"Add a get method to return a list of missions:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"@Get()\ngetMissions() {\n  return [\n    {\n      description: 'save the world',\n      complete: false,\n    },\n  ];\n}\n")),(0,i.kt)("h3",{id:"configure-cypress"},"Configure Cypress"),(0,i.kt)("p",null,"Launch Cypress and configure e2e"),(0,i.kt)("p",null,"update config with baseUrl:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"e2e: {\n  baseUrl: 'http://localhost:3000',\n  setupNodeEvents(on, config) {\n    // implement node event listeners here\n  },\n},\n")),(0,i.kt)("p",null,"Import plugin in support file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=cypress/support/e2e.ts",title:"cypress/support/e2e.ts"},"import 'cypress-plugin-api';\n")),(0,i.kt)("p",null,"Start nest server:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"npm run start:dev\n")),(0,i.kt)("p",null,"Add first test:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=cypress/e2e/mission.api.cy.ts",title:"cypress/e2e/mission.api.cy.ts"},"describe('missions api', () => {\n  it('should get missions', () => {\n    cy.api('/missions').as('response');\n    cy.get('@response').its('status').should('equal', 200);\n  });\n});\n")),(0,i.kt)("h2",{id:"add-service"},"Add service"),(0,i.kt)("p",null,"Refactor code to pull from service"),(0,i.kt)("p",null,"create service"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"nest g service missions\n")),(0,i.kt)("p",null,"Show how service was added to module"),(0,i.kt)("p",null,"Replace the service:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=src/missions/missions.service.ts",title:"src/missions/missions.service.ts"},"import { Injectable } from '@nestjs/common';\n\nexport interface Mission {\n  id?: number;\n  description: string;\n  complete: boolean;\n}\n\nconst defaultMission: Mission = {\n  id: 1,\n  description: 'save the galaxy',\n  complete: false,\n};\n\n@Injectable()\nexport class MissionsService {\n  missions: Mission[] = [{ ...defaultMission }];\n\n  getAll() {\n    return this.missions;\n  }\n}\n")),(0,i.kt)("p",null,"update controller:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"import { Controller, Get } from '@nestjs/common';\nimport { MissionsService } from './missions.service';\n\n@Controller('missions')\nexport class MissionsController {\n  constructor(private missionsService: MissionsService) {}\n\n  @Get()\n  getMissions() {\n    return this.missionsService.getAll();\n  }\n}\n")),(0,i.kt)("h2",{id:"get-single-mission"},"Get single mission"),(0,i.kt)("p",null,"add test:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"it('should get single mission', () => {\n  cy.api('/missions/1').as('response');\n  cy.get('@response').its('status').should('equal', 200);\n  cy.get('@response').its('body').should('include', {\n    id: 1,\n    description: 'take out the trash',\n    complete: false,\n  });\n});\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"//service\nget(id: number) {\n  const mission = this.missions.find(x => x.id === id);\n  return mission;\n}\n\n//controller\n@Get(':id')\nget(@Param('id') id: number) {\n  return this.missionsService.get(id);\n}\n")),(0,i.kt)("p",null,"show no response is coming back, but the status code is 200. debug to show why."),(0,i.kt)("p",null,"update the controller get to use parse int pipe:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"@Get(':id')\ngetMission(@Param('id', ParseIntPipe) id: number) {\n  return this.missionsService.get(id);\n}\n")),(0,i.kt)("p",null,"Show it now works. However, show it still fails in the same way as before if we\npass an id that doesn't exist, like 100."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"it('should throw 404 if single mission is not found', () => {\n  cy.api({\n    url: '/missions/100',\n    failOnStatusCode: false,\n  }).as('response');\n  cy.get('@response').its('status').should('equal', 404);\n});\n")),(0,i.kt)("p",null,"Update the service to throw a NotFoundException"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"get(id: number) {\n  const mission = this.missions.find((x) => x.id === id);\n  if (!mission) {\n    throw new NotFoundException();\n  }\n  return mission;\n}\n")),(0,i.kt)("h3",{id:"add-delete-method"},"add delete method"),(0,i.kt)("p",null,"add test:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"it('can delete mission', () => {\n  cy.api('DELETE', '/missions/1').as('response');\n  cy.get('@response').its('status').should('equal', 204);\n});\n")),(0,i.kt)("p",null,"add controller/service"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"@Delete(':id')\n@HttpCode(204)\ndeleteMission(@Param('id', ParseIntPipe) id: number) {\n  this.missionsService.delete(id);\n}\n\ndelete(id: number) {\n  this.missions = this.missions.filter((x) => x.id !== id);\n}\n")),(0,i.kt)("h2",{id:"add-db-reset-for-testing"},"add db reset for testing"),(0,i.kt)("p",null,"service/controller"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"@Post('/reset')\nreset() {\n  if (process.env.NODE_ENV === 'test' || process.env.NODE_ENV === 'dev') {\n    this.missionsService.reset();\n  }\n}\n\nreset() {\n  this.missions = [{ ...defaultMission }];\n}\n")),(0,i.kt)("p",null,"add dev env to start script:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'"start:dev": "NODE_ENV=dev nest start --watch",\n"start:test": "NODE_ENV=test nest start",\n')),(0,i.kt)("p",null,"add beforeEach call in e2e.ts"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=cypress/support/e2e.ts",title:"cypress/support/e2e.ts"},"beforeEach(() => {\n  cy.request({\n    log: false,\n    method: 'POST',\n    url: '/missions/reset',\n    headers: {\n      Authorization: 'resetcreds',\n    },\n  });\n  cy.log('seeding db');\n});\n")),(0,i.kt)("h2",{id:"add-mission-method"},"add mission method"),(0,i.kt)("p",null,"test:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"it('can add mission', () => {\n  const mission = {\n    description: 'test mission',\n    complete: false,\n  };\n  cy.api('POST', '/missions', mission).as('response');\n  cy.get('@response').its('status').should('equal', 201);\n  cy.get('@response').its('body').should('include', mission);\n});\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"//controller\n@Post()\naddMission(@Body() mission: Mission) {\n  return this.missionsService.add(mission);\n}\n\n//service\nadd(mission: Mission) {\n  const newId = Math.max(...this.missions.map((x) => x.id)) + 1;\n  mission.id = newId;\n  this.missions.push(mission);\n  return mission;\n}\n")),(0,i.kt)("h2",{id:"update-mission"},"update mission"),(0,i.kt)("p",null,"test:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"it('should update mission', () => {\n  const mission = {\n    description: 'get cat out of tree',\n    complete: true,\n  };\n  cy.api({\n    url: '/missions/1',\n    method: 'PUT',\n    body: mission,\n  }).as('response');\n  cy.get('@response').its('status').should('equal', 200);\n  cy.get('@response').its('body').should('include', mission);\n});\n")),(0,i.kt)("p",null,"code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"//service\nupdate(id: number, mission: Mission) {\n  mission.id = id;\n  this.missions = this.missions.map((x) => {\n    return x.id === id ? mission : x;\n  });\n  return this.get(id);\n}\n\n//controller\n@Put(':id')\nupdateMission(\n  @Param('id', ParseIntPipe) id: number,\n  @Body() mission,\n) {\n  return this.missionsService.update(id, mission);\n}\n")),(0,i.kt)("h2",{id:"validation"},"Validation"),(0,i.kt)("p",null,"add class transformer and validator:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"npm i class-transformer class-validator\n")),(0,i.kt)("p",null,"refactor Mission into class and move to new file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=Mission.ts",title:"Mission.ts"},"export class Mission {\n  id?: number;\n  description: string;\n  complete: boolean;\n  created: string;\n\n  constructor(partial: Partial<Mission>) {\n    Object.assign(this, partial);\n  }\n}\n")),(0,i.kt)("p",null,"update missions and reset to use class in service:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"//missions\nmissions: Mission[] = [new Mission(defaultMission)];\n\n//reset\nreset() {\n  this.missions = [new Mission(defaultMission)];\n}\n")),(0,i.kt)("p",null,"update Mission class to use decorators"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"import { IsString, IsNotEmpty, IsBoolean } from 'class-validator';\n\nexport class Mission {\n  id?: number;\n\n  @IsString({ message: 'description must be a string' })\n  @IsNotEmpty({ message: 'description must not be an empty string' })\n  description: string;\n\n  @IsBoolean({ message: 'complete must be a boolean' })\n  complete: boolean;\n  created: string;\n}\n")),(0,i.kt)("p",null,"use validationpipe in app.module:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"{\n  provide: APP_PIPE,\n  useValue: new ValidationPipe({ transform: true }),\n},\n")),(0,i.kt)("p",null,"delete parseint pipe from controller because the validator will now convert\ntypes automatically"),(0,i.kt)("h2",{id:"exclude-properties"},"Exclude properties"),(0,i.kt)("p",null,"add check to get single mission test to check for created:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"cy.get('@response').its('body.created').should('be.undefined');\n")),(0,i.kt)("p",null,"Add exclude decorator to created prop on class"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"import { Exclude } from 'class-transformer';\n\n//prop\n@Exclude()\ncreated: string;\n")),(0,i.kt)("p",null,"show fail, then add ClassSerializerInterceptor to module providers:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"{\n  provide: APP_INTERCEPTOR,\n  useClass: ClassSerializerInterceptor,\n},\n")),(0,i.kt)("h2",{id:"protect-reset-db-route-with-guard"},"Protect reset db route with guard"),(0,i.kt)("p",null,"create guard:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"nest g guard TestEnvOnly\n")),(0,i.kt)("p",null,"update guard:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=test-env-only.guard.ts",title:"test-env-only.guard.ts"},"import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';\nimport { Observable } from 'rxjs';\n\n@Injectable()\nexport class TestEnvOnlyGuard implements CanActivate {\n  canActivate(\n    context: ExecutionContext\n  ): boolean | Promise<boolean> | Observable<boolean> {\n    const request = context.switchToHttp().getRequest();\n\n    if (!(process.env.NODE_ENV === 'test' || process.env.NODE_ENV === 'dev')) {\n      return false;\n    }\n\n    if (request.headers.authorization !== 'resetcreds') {\n      return false;\n    }\n\n    return true;\n  }\n}\n")),(0,i.kt)("p",null,"add guard to just reset method:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"@UseGuards(TestEnvOnlyGuard)\n@Post('/reset')\nreset() {\n  this.missionsService.reset();\n}\n")))}c.isMDXComponent=!0}}]);